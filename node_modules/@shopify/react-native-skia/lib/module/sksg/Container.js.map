{"version":3,"names":["Rea","HAS_REANIMATED","HAS_REANIMATED_3","createDrawingContext","draw","isSharedValue","drawOnscreen","Skia","nativeId","root","rec","PictureRecorder","canvas","beginRecording","ctx","forEach","node","picture","finishRecordingAsPicture","SkiaViewApi","setJsiProperty","Container","constructor","_defineProperty","Set","_root","isOnscreen","Error","mapperId","stopMapper","startMapper","Array","from","values","clear","console","log","redraw","runOnUI","getNativeId","unregisterValues","Object","filter","value","delete","registerValues","add","drawOnCanvas"],"sources":["Container.ts"],"sourcesContent":["import { type SharedValue } from \"react-native-reanimated\";\n\nimport Rea from \"../external/reanimated/ReanimatedProxy\";\nimport type { Skia, SkCanvas } from \"../skia/types\";\nimport {\n  HAS_REANIMATED,\n  HAS_REANIMATED_3,\n} from \"../external/reanimated/renderHelpers\";\n\nimport { createDrawingContext } from \"./DrawingContext\";\nimport type { Node } from \"./nodes\";\nimport { draw, isSharedValue } from \"./nodes\";\n\nconst drawOnscreen = (Skia: Skia, nativeId: number, root: Node[]) => {\n  \"worklet\";\n  const rec = Skia.PictureRecorder();\n  const canvas = rec.beginRecording();\n  // TODO: This is only support from 3.15 and above (check the exact version)\n  // This could be polyfilled in C++ if needed (or in JS via functions only?)\n  const ctx = createDrawingContext(Skia, canvas);\n  root.forEach((node) => {\n    draw(ctx, node);\n  });\n  const picture = rec.finishRecordingAsPicture();\n  SkiaViewApi.setJsiProperty(nativeId, \"picture\", picture);\n};\n\nexport class Container {\n  public _root: Node[] = [];\n  public unmounted = false;\n\n  private values = new Set<SharedValue<unknown>>();\n  private mapperId: number | null = null;\n\n  constructor(public Skia: Skia, private nativeId: number) {}\n\n  get root() {\n    return this._root;\n  }\n\n  set root(root: Node[]) {\n    const isOnscreen = this.nativeId !== -1;\n    if (HAS_REANIMATED && !HAS_REANIMATED_3) {\n      throw new Error(\"React Native Skia only supports Reanimated 3 and above\");\n    }\n    if (isOnscreen) {\n      if (this.mapperId !== null) {\n        Rea.stopMapper(this.mapperId);\n      }\n      const { nativeId, Skia } = this;\n      this.mapperId = Rea.startMapper(() => {\n        \"worklet\";\n        drawOnscreen(Skia, nativeId, root);\n      }, Array.from(this.values));\n    }\n    this._root = root;\n  }\n\n  clear() {\n    console.log(\"clear container\");\n  }\n\n  redraw() {\n    const isOnscreen = this.nativeId !== -1;\n    if (HAS_REANIMATED && !HAS_REANIMATED_3) {\n      throw new Error(\"React Native Skia only supports Reanimated 3 and above\");\n    }\n    if (isOnscreen) {\n      const { nativeId, Skia, root } = this;\n      Rea.runOnUI(() => {\n        drawOnscreen(Skia, nativeId, root);\n      })();\n    }\n  }\n\n  getNativeId() {\n    return this.nativeId;\n  }\n\n  unregisterValues(values: object) {\n    Object.values(values)\n      .filter(isSharedValue)\n      .forEach((value) => {\n        this.values.delete(value);\n      });\n  }\n\n  registerValues(values: object) {\n    Object.values(values)\n      .filter(isSharedValue)\n      .forEach((value) => {\n        this.values.add(value);\n      });\n  }\n\n  drawOnCanvas(canvas: SkCanvas) {\n    const ctx = createDrawingContext(this.Skia, canvas);\n    this.root.forEach((node) => {\n      draw(ctx, node);\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}