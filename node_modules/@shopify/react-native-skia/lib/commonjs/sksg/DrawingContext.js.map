{"version":3,"names":["_nodes","require","_types","computeClip","Skia","clip","isPathDef","clipPath","processPath","isRRect","clipRRect","clipRect","undefined","processColor","color","Color","Array","isArray","Float32Array","Error","createDrawingContext","canvas","state","paints","Paint","getPaint","length","processPaint","opacity","strokeWidth","blendMode","style","strokeJoin","strokeCap","strokeMiter","antiAlias","dither","paint","paintProp","declCtx","push","shouldRestore","colorFilter","colorFilters","popAllAsOne","imageFilter","imageFilters","shader","shaders","pop","maskFilter","maskFilters","pathEffect","pathEffects","copy","setAlphaf","getAlphaf","currentOpacity","setShader","setColor","setStrokeWidth","setBlendMode","BlendMode","enumKey","setStyle","PaintStyle","setStrokeJoin","StrokeJoin","setStrokeCap","StrokeCap","setStrokeMiter","setAntiAlias","setDither","setColorFilter","setImageFilter","setMaskFilter","setPathEffect","processMatrixAndClipping","props","layer","hasTransform","matrix","transform","hasClip","op","invertClip","ClipOp","Difference","Intersect","m3","processTransformProps2","shouldSave","saveLayer","save","concat","restore","exports"],"sources":["DrawingContext.ts"],"sourcesContent":["import {\n  enumKey,\n  isPathDef,\n  processPath,\n  processTransformProps2,\n} from \"../dom/nodes\";\nimport type { ClipDef, DrawingNodeProps, GroupProps } from \"../dom/types\";\nimport {\n  BlendMode,\n  ClipOp,\n  isRRect,\n  PaintStyle,\n  StrokeCap,\n  StrokeJoin,\n} from \"../skia/types\";\nimport type {\n  SkPath,\n  SkRect,\n  SkRRect,\n  SkCanvas,\n  Skia,\n  SkPaint,\n} from \"../skia/types\";\n\nimport type { DeclarationContext } from \"./DeclarationContext\";\n\nconst computeClip = (\n  Skia: Skia,\n  clip: ClipDef | undefined\n):\n  | undefined\n  | { clipPath: SkPath }\n  | { clipRect: SkRect }\n  | { clipRRect: SkRRect } => {\n  \"worklet\";\n  if (clip) {\n    if (isPathDef(clip)) {\n      return { clipPath: processPath(Skia, clip) };\n    } else if (isRRect(clip)) {\n      return { clipRRect: clip };\n    } else {\n      return { clipRect: clip };\n    }\n  }\n  return undefined;\n};\n\nconst processColor = (\n  Skia: Skia,\n  color: number | string | Float32Array | number[]\n) => {\n  \"worklet\";\n  if (typeof color === \"string\" || typeof color === \"number\") {\n    return Skia.Color(color);\n  } else if (Array.isArray(color) || color instanceof Float32Array) {\n    return color instanceof Float32Array ? color : new Float32Array(color);\n  } else {\n    throw new Error(\n      `Invalid color type: ${typeof color}. Expected number, string, or array.`\n    );\n  }\n};\n\nexport const createDrawingContext = (Skia: Skia, canvas: SkCanvas) => {\n  \"worklet\";\n  const state = {\n    paints: [Skia.Paint()],\n  };\n\n  const getPaint = () => {\n    return state.paints[state.paints.length - 1];\n  };\n\n  const processPaint = (\n    {\n      opacity,\n      color,\n      strokeWidth,\n      blendMode,\n      style,\n      strokeJoin,\n      strokeCap,\n      strokeMiter,\n      antiAlias,\n      dither,\n      paint: paintProp,\n    }: DrawingNodeProps,\n    declCtx: DeclarationContext\n  ) => {\n    if (paintProp) {\n      declCtx.paints.push(paintProp);\n      return true;\n    }\n    let shouldRestore = false;\n    const colorFilter = declCtx.colorFilters.popAllAsOne();\n    const imageFilter = declCtx.imageFilters.popAllAsOne();\n    const shader = declCtx.shaders.pop();\n    const maskFilter = declCtx.maskFilters.pop();\n    const pathEffect = declCtx.pathEffects.popAllAsOne();\n\n    if (\n      opacity !== undefined ||\n      color !== undefined ||\n      strokeWidth !== undefined ||\n      blendMode !== undefined ||\n      style !== undefined ||\n      strokeJoin !== undefined ||\n      strokeCap !== undefined ||\n      strokeMiter !== undefined ||\n      antiAlias !== undefined ||\n      dither !== undefined ||\n      colorFilter !== undefined ||\n      imageFilter !== undefined ||\n      shader !== undefined ||\n      maskFilter !== undefined ||\n      pathEffect !== undefined\n    ) {\n      if (!shouldRestore) {\n        state.paints.push(getPaint().copy());\n        shouldRestore = true;\n      }\n    }\n\n    const paint = getPaint();\n    if (opacity !== undefined) {\n      paint.setAlphaf(paint.getAlphaf() * opacity);\n    }\n    if (color !== undefined) {\n      const currentOpacity = paint.getAlphaf();\n      paint.setShader(null);\n      paint.setColor(processColor(Skia, color));\n      paint.setAlphaf(currentOpacity * paint.getAlphaf());\n    }\n    if (strokeWidth !== undefined) {\n      paint.setStrokeWidth(strokeWidth);\n    }\n    if (blendMode !== undefined) {\n      paint.setBlendMode(BlendMode[enumKey(blendMode)]);\n    }\n    if (style !== undefined) {\n      paint.setStyle(PaintStyle[enumKey(style)]);\n    }\n    if (strokeJoin !== undefined) {\n      paint.setStrokeJoin(StrokeJoin[enumKey(strokeJoin)]);\n    }\n    if (strokeCap !== undefined) {\n      paint.setStrokeCap(StrokeCap[enumKey(strokeCap)]);\n    }\n    if (strokeMiter !== undefined) {\n      paint.setStrokeMiter(strokeMiter);\n    }\n    if (antiAlias !== undefined) {\n      paint.setAntiAlias(antiAlias);\n    }\n    if (dither !== undefined) {\n      paint.setDither(dither);\n    }\n    if (colorFilter) {\n      paint.setColorFilter(colorFilter);\n    }\n    if (imageFilter) {\n      paint.setImageFilter(imageFilter);\n    }\n    if (shader) {\n      paint.setShader(shader);\n    }\n    if (maskFilter) {\n      paint.setMaskFilter(maskFilter);\n    }\n    if (pathEffect) {\n      paint.setPathEffect(pathEffect);\n    }\n    return shouldRestore;\n  };\n\n  const processMatrixAndClipping = (\n    props: GroupProps,\n    layer?: boolean | SkPaint\n  ) => {\n    const hasTransform =\n      props.matrix !== undefined || props.transform !== undefined;\n    const clip = computeClip(Skia, props.clip);\n    const hasClip = clip !== undefined;\n    const op = props.invertClip ? ClipOp.Difference : ClipOp.Intersect;\n    const m3 = processTransformProps2(Skia, props);\n    const shouldSave = hasTransform || hasClip || !!layer;\n\n    if (shouldSave) {\n      if (layer) {\n        if (typeof layer === \"boolean\") {\n          canvas.saveLayer();\n        } else {\n          canvas.saveLayer(layer);\n        }\n      } else {\n        canvas.save();\n      }\n    }\n\n    if (m3) {\n      canvas.concat(m3);\n    }\n    if (clip) {\n      if (\"clipRect\" in clip) {\n        canvas.clipRect(clip.clipRect, op, true);\n      } else if (\"clipRRect\" in clip) {\n        canvas.clipRRect(clip.clipRRect, op, true);\n      } else {\n        canvas.clipPath(clip.clipPath, op, true);\n      }\n    }\n    return shouldSave;\n  };\n\n  return {\n    Skia,\n    canvas,\n    save: () => state.paints.push(getPaint().copy()),\n    restore: () => state.paints.pop(),\n    getPaint,\n    processPaint,\n    processMatrixAndClipping,\n  };\n};\n\nexport type DrawingContext = ReturnType<typeof createDrawingContext>;\n"],"mappings":"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","ignoreList":[]}