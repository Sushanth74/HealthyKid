{"version":3,"names":["_ReanimatedProxy","_interopRequireDefault","require","_renderHelpers","_DrawingContext","_nodes","e","__esModule","default","_defineProperty","r","t","_toPropertyKey","Object","defineProperty","value","enumerable","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","drawOnscreen","Skia","nativeId","root","rec","PictureRecorder","canvas","beginRecording","ctx","createDrawingContext","forEach","node","draw","picture","finishRecordingAsPicture","SkiaViewApi","setJsiProperty","Container","constructor","Set","_root","isOnscreen","HAS_REANIMATED","HAS_REANIMATED_3","Error","mapperId","Rea","stopMapper","startMapper","Array","from","values","clear","console","log","redraw","runOnUI","getNativeId","unregisterValues","filter","isSharedValue","delete","registerValues","add","drawOnCanvas","exports"],"sources":["Container.ts"],"sourcesContent":["import { type SharedValue } from \"react-native-reanimated\";\n\nimport Rea from \"../external/reanimated/ReanimatedProxy\";\nimport type { Skia, SkCanvas } from \"../skia/types\";\nimport {\n  HAS_REANIMATED,\n  HAS_REANIMATED_3,\n} from \"../external/reanimated/renderHelpers\";\n\nimport { createDrawingContext } from \"./DrawingContext\";\nimport type { Node } from \"./nodes\";\nimport { draw, isSharedValue } from \"./nodes\";\n\nconst drawOnscreen = (Skia: Skia, nativeId: number, root: Node[]) => {\n  \"worklet\";\n  const rec = Skia.PictureRecorder();\n  const canvas = rec.beginRecording();\n  // TODO: This is only support from 3.15 and above (check the exact version)\n  // This could be polyfilled in C++ if needed (or in JS via functions only?)\n  const ctx = createDrawingContext(Skia, canvas);\n  root.forEach((node) => {\n    draw(ctx, node);\n  });\n  const picture = rec.finishRecordingAsPicture();\n  SkiaViewApi.setJsiProperty(nativeId, \"picture\", picture);\n};\n\nexport class Container {\n  public _root: Node[] = [];\n  public unmounted = false;\n\n  private values = new Set<SharedValue<unknown>>();\n  private mapperId: number | null = null;\n\n  constructor(public Skia: Skia, private nativeId: number) {}\n\n  get root() {\n    return this._root;\n  }\n\n  set root(root: Node[]) {\n    const isOnscreen = this.nativeId !== -1;\n    if (HAS_REANIMATED && !HAS_REANIMATED_3) {\n      throw new Error(\"React Native Skia only supports Reanimated 3 and above\");\n    }\n    if (isOnscreen) {\n      if (this.mapperId !== null) {\n        Rea.stopMapper(this.mapperId);\n      }\n      const { nativeId, Skia } = this;\n      this.mapperId = Rea.startMapper(() => {\n        \"worklet\";\n        drawOnscreen(Skia, nativeId, root);\n      }, Array.from(this.values));\n    }\n    this._root = root;\n  }\n\n  clear() {\n    console.log(\"clear container\");\n  }\n\n  redraw() {\n    const isOnscreen = this.nativeId !== -1;\n    if (HAS_REANIMATED && !HAS_REANIMATED_3) {\n      throw new Error(\"React Native Skia only supports Reanimated 3 and above\");\n    }\n    if (isOnscreen) {\n      const { nativeId, Skia, root } = this;\n      Rea.runOnUI(() => {\n        drawOnscreen(Skia, nativeId, root);\n      })();\n    }\n  }\n\n  getNativeId() {\n    return this.nativeId;\n  }\n\n  unregisterValues(values: object) {\n    Object.values(values)\n      .filter(isSharedValue)\n      .forEach((value) => {\n        this.values.delete(value);\n      });\n  }\n\n  registerValues(values: object) {\n    Object.values(values)\n      .filter(isSharedValue)\n      .forEach((value) => {\n        this.values.add(value);\n      });\n  }\n\n  drawOnCanvas(canvas: SkCanvas) {\n    const ctx = createDrawingContext(this.Skia, canvas);\n    this.root.forEach((node) => {\n      draw(ctx, node);\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}